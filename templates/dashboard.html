<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard - RANE MADRAS LIMITED Discrepancy Portal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"> 
  <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml"> 
</head>
<body>
<header class="site-header">
    <div class="container header-row header-bar">
        <div class="header-left">
            <a class="btn secondary" href="{{ url_for('home') }}">Home</a>
        </div>
        <div class="header-center">
            <div class="brand">
                <div class="brand-text">
                    <h1>RANE MADRAS LIMITED</h1>
                    <p>Dashboard</p>
                </div>
            </div>
        </div>
        <div class="header-right">
            <a class="btn secondary" href="{{ url_for('admin') }}">Admin</a>
        </div>
    </div>
</header> 

<div class="container">
  <h2>Overview</h2>
  <div style="display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start">
    <div>
      <div class="card" style="margin-bottom:18px">
        <h3>Submissions Over Time</h3>
        <canvas id="timeseriesChart" height="120"></canvas>
      </div>

      <div class="card">
        <h3>Top Transporters</h3>
        <canvas id="transportChart" height="160"></canvas>
      </div>

      <!-- Analysis Card (pivot-like) -->
      <div class="analysis-card" style="padding:18px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f7fbff);border:1px solid #eef6ff;margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <h3 style="margin:0;display:flex;align-items:center;gap:8px">Analysis <small class="muted">(pivot)</small></h3>
          <div class="small-muted" style="font-size:0.9rem">Quick pivot-style breakdown â€” choose metric & grouping</div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
          <label style="font-size:0.9rem">Metric</label>
          <select id="analysis-metric">
            <option value="short">Short</option>
            <option value="excess">Excess</option>
            <option value="damage">Damage</option>
            <option value="mismatch">Mismatch Parts</option>
          </select>

          <label style="font-size:0.9rem">Group By</label>
          <select id="analysis-group">
            <option value="transporter">Transporter</option>
            <option value="customer">Customer</option>
            <option value="warehouse">Warehouse</option>
            <option value="warehouse_code">Warehouse Code</option>
            <option value="invoice">Invoice No</option>
            <option value="part_no">Part No</option>
            <option value="city">City</option>
          </select>

          <label style="font-size:0.9rem">Top</label>
          <select id="analysis-top">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>

          <label style="font-size:0.9rem">Date From</label>
          <input type="date" id="analysis-date-from">
          <label style="font-size:0.9rem">Date To</label>
          <input type="date" id="analysis-date-to">

          <label style="font-size:0.9rem">Warehouse</label>
          <select id="analysis-warehouse">
            <option value="">All</option>
            {% for w in warehouses_all %}
              <option value="{{ w }}">{{ w }}</option>
            {% endfor %}
          </select>

          <button class="btn" id="analysis-fetch">Fetch</button>
          <div style="display:flex;gap:8px">
            <button class="btn secondary" id="analysis-download-csv">CSV</button>
            <button class="btn secondary" id="analysis-download-xlsx">XLSX</button>
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1">
            <div style="max-height:240px;overflow:auto;border:1px solid #eef4ff;border-radius:6px;padding:8px;background:#fff">
              <table id="analysis-table" style="width:100%;border-collapse:collapse">
                <thead style="background:#fbfdff"><tr><th style="padding:8px;text-align:left">Group</th><th style="padding:8px;text-align:right">Value</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="analysis-empty" class="muted" style="display:none;padding:12px">No data for the selected filters.</div>
            </div>
          </div>
          <div style="width:260px">
            <canvas id="analysisChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Warehouse Distribution</h3>
        <canvas id="warehouseChart" height="240"></canvas>
      </div>

      <div style="margin-top:18px;padding:12px;border-radius:8px;background:#f8fafc;border:1px solid #eef4ff">
        <h4>Tips</h4>
        <div class="muted">Use filters on the Admin page to narrow results and then download a filtered CSV for deeper analysis.</div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadStats(){
  const res = await fetch('/api/stats');
  if(!res.ok){ console.error('Failed to fetch stats'); return; }
  const data = await res.json();

  // Timeseries
  const dates = data.timeseries.map(r => r.date);
  const counts = data.timeseries.map(r => r.count);
  const ctxTs = document.getElementById('timeseriesChart').getContext('2d');
  new Chart(ctxTs, {
    type: 'line',
    data: { labels: dates, datasets: [{ label: 'Submissions', data: counts, backgroundColor: 'rgba(11,90,223,0.08)', borderColor: '#0b5adf', fill: true, tension:0.2 }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:true}, y:{beginAtZero:true}} }
  });

  // Warehouse pie
  const warehouseLabels = Object.keys(data.warehouses || {});
  const warehouseCounts = Object.values(data.warehouses || {});
  const ctxWh = document.getElementById('warehouseChart').getContext('2d');
  new Chart(ctxWh, { type:'pie', data:{ labels: warehouseLabels, datasets:[{ data: warehouseCounts, backgroundColor: ['#0b5adf','#f59e0b','#10b981','#ef4444','#6b7280','#6b21a8'] }] }, options:{responsive:true, plugins:{legend:{position:'right'}}}});

  // Transporters bar
  const transporters = (data.top_transporters || []).map(r => r.transporter);
  const transporterCounts = (data.top_transporters || []).map(r => r.count);
  const ctxTrans = document.getElementById('transportChart').getContext('2d');
  new Chart(ctxTrans, { type:'bar', data:{ labels: transporters, datasets:[{ label:'Submissions', data:transporterCounts, backgroundColor:'#0b5adf' }] }, options:{indexAxis:'y', responsive:true, plugins:{legend:{display:false}}} });
}

window.addEventListener('DOMContentLoaded', ()=>{ loadStats(); loadAnalysis(); });

async function loadAnalysis(){
  const metricSelect = document.getElementById('analysis-metric');
  const groupSelect = document.getElementById('analysis-group');
  const topSelect = document.getElementById('analysis-top');
  const table = document.querySelector('#analysis-table tbody');
  const ctx = document.getElementById('analysisChart').getContext('2d');
  let chart = null;

  function queryParams(){
    const metric = metricSelect.value;
    const group = groupSelect.value;
    const top = topSelect.value;
    const date_from = document.getElementById('analysis-date-from').value || '';
    const date_to = document.getElementById('analysis-date-to').value || '';
    const warehouse = document.getElementById('analysis-warehouse').value || '';
    const params = new URLSearchParams();
    params.set('metric', metric);
    params.set('group_by', group);
    params.set('top_n', top);
    if(date_from) params.set('date_from', date_from);
    if(date_to) params.set('date_to', date_to);
    if(warehouse) params.set('warehouse', warehouse);
    return params.toString();
  }

  async function fetchAndRender(){
    const q = '?' + queryParams();
    const res = await fetch('/api/analysis'+q);
    if(!res.ok){ console.error('Failed to fetch analysis'); return }
    const data = await res.json();
    // table
    table.innerHTML = '';
    data.rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="padding:8px">${r.group}</td><td style="padding:8px;text-align:right">${r.value}</td>`;
      table.appendChild(tr);
    });
    // chart
    const labels = data.rows.map(r=>r.group);
    const vals = data.rows.map(r=>r.value);
    if(chart) chart.destroy();
    chart = new Chart(ctx, { type:'bar', data:{ labels: labels, datasets:[{ label: data.metric, data: vals, backgroundColor:'#0b5adf' }] }, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}} } });
  }

  document.getElementById('analysis-fetch').addEventListener('click', (e)=>{ e.preventDefault(); fetchAndRender(); });
  document.getElementById('analysis-download-csv').addEventListener('click', (e)=>{ e.preventDefault(); downloadExport('csv'); });
  document.getElementById('analysis-download-xlsx').addEventListener('click', (e)=>{ e.preventDefault(); downloadExport('xlsx'); });

  async function downloadExport(format){
    const q = '?' + queryParams() + '&format=' + format;
    const res = await fetch('/api/analysis/export'+q);
    if(!res.ok){ console.error('Export failed'); return }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `analysis.${format==='xlsx'?'xlsx':'csv'}`; a.click(); URL.revokeObjectURL(url);
  }

  // initial fetch
  fetchAndRender();
}
</script>
</body>
</html>